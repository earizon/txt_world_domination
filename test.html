<!DOCTYPE html>
<html>
   <meta charset="UTF-8">
   <meta name="viewport"
     content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>TXT World Domination</title>
   <head>
<style>
@font-face{
  font-family: 'source_code_pro';
  font-weight: 400;
  font-style: normal;
  font-stretch: normal;
  src: url('./source-code-pro/EOT/SourceCodePro-Regular.eot') format('embedded-opentype'),
       url('./source-code-pro/WOFF2/TTF/SourceCodePro-Regular.ttf.woff2') format('woff2'),
       url('./source-code-pro/WOFF/OTF/SourceCodePro-Regular.otf.woff') format('woff'),
       url('./source-code-pro/OTF/SourceCodePro-Regular.otf') format('opentype'),
       url('./source-code-pro/TTF/SourceCodePro-Regular.ttf') format('truetype') ;
}
pre { font-family:'source_code_pro',monospace, console; font-size:1em; }
#idControlPanel { border-bottom: 1px solid black; }
</style>
<script type="module">
import { html, render } from './preact.standalone.module.js';
import { ControlPanel } from './control_panel.js';

const fetchPayload = function (url) {
  const xhr = new XMLHttpRequest();
  return new Promise( (resolve,reject) => {
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Cache-Control', 'no-cache')
    xhr.onreadystatechange = function() {
      if (xhr.readyState != 4) return
      if (xhr.status != 200) return
      resolve(
         xhr.responseText
      )
    }
    xhr.send()
  } )
}

const doTxtPreProcessing = function () {
   let   H = STATE.payload
   // NEXT) replace html scape chars 
   H = H.replaceAll('<','&lt;') 
        .replaceAll('>','&gt;')

   // NEXT) replace External links
   H = H.replace(
       /@\[((http|[.][/]).?[^\]]*)\]/g,
       " ▶<a target='_blank' href='$1'>$1</a>◀")   

   // NEXT) replace relative (to page) link
   H = H.replace(
       /@\[([^\]]*)\]/g,
       " ▷<a href='$1'>$1</a>◁")   
   STATE.payload = H
}

const getParameterByName = function(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

const STATE = {
   payload : "",
   output  : ""
}
window.STATE = STATE // help debugging

const grep = () => {
   STATE.output = STATE.payload
   // TODO:(0)
   document.getElementById("id_mainText").innerHTML = STATE.output
}

const bootstrap = async function () {
  render( html` <${ControlPanel} />`, document.getElementById("idControlPanel"))
  const URLtxtDDBB = getParameterByName('URLtxtDDBB')
  STATE.payload = await fetchPayload(URLtxtDDBB)
  doTxtPreProcessing()
  grep()
}


window.addEventListener('load', bootstrap )
</script>
</head>
<body>
<pre id="idControlPanel">
</pre>
<pre id="id_mainText">
</pre>

</body>
</html>
